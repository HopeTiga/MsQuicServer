# MsQuic 多进程服务器架构

## 项目概述

该项目是一个基于 MsQuic 协议的多进程服务器系统，采用主从架构设计，支持多个子进程同时运行 MsQuic 服务器实例，实现高并发、高可用的网络通信服务。

## 系统架构

### 1. 核心组件

#### 1.1 进程管理层

- **主进程**：负责子进程的创建、监控和管理
- **子进程**：每个子进程运行一个独立的 MsQuic 服务器实例
- **进程间通信**：通过共享内存实现主进程与子进程之间的通信

#### 1.2 网络通信层

- **MsQuic 服务器**：基于微软 QUIC 协议实现的高性能服务器
- **会话管理**：处理客户端连接和会话生命周期
- **流处理**：管理 QUIC 协议的数据流

#### 1.3 功能模块

- **文件传输**：支持大小文件的高效传输
- **任务调度**：线程池实现任务的异步处理
- **系统命令处理**：支持各种系统级操作命令

### 2. 详细架构图

```
┌─────────────────────────────────────────────────────────────┐
│                       主进程 (Manager)                       │
│                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────────┐    │
│  │ 命令处理器  │   │ 配置管理器  │   │ 端口分配管理器 │    │
│  └─────────────┘   └─────────────┘   └─────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │               共享内存通信管理器                    │    │
│  └─────────────────────────────────────────────────────┘    │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────┬─────────────┬─────────────┬─────────────────┐
│  子进程 0   │  子进程 1   │  子进程 2   │    子进程 N     │
│ (端口4433)  │ (端口4434)  │ (端口4435)  │  (端口443X)     │
│             │             │             │                 │
│ ┌─────────┐ │ ┌─────────┐ │ ┌─────────┐ │ ┌─────────┐     │
│ │MsQuic   │ │ │MsQuic   │ │ │MsQuic   │ │ │MsQuic   │     │
│ │服务器   │ │ │服务器   │ │ │服务器   │ │ │服务器   │     │
│ └─────────┘ │ └─────────┘ │ └─────────┘ │ └─────────┘     │
│             │             │             │                 │
│ ┌─────────┐ │ ┌─────────┐ │ ┌─────────┐ │ ┌─────────┐     │
│ │会话管理 │ │ │会话管理 │ │ │会话管理 │ │ │会话管理 │     │
│ └─────────┘ │ └─────────┘ │ └─────────┘ │ └─────────┘     │
│             │             │             │                 │
│ ┌─────────┐ │ ┌─────────┐ │ ┌─────────┐ │ ┌─────────┐     │
│ │文件传输 │ │ │文件传输 │ │ │文件传输 │ │ │文件传输 │     │
│ └─────────┘ │ └─────────┘ │ └─────────┘ │ └─────────┘     │
└─────────────┴─────────────┴─────────────┴─────────────────┘
```

## 核心类结构

### 1. 进程管理

- **主进程**：`main.cpp` 中的主函数
  - 负责创建和管理子进程
  - 处理用户命令
  - 分配和管理端口资源

- **子进程**：`runChildProcess` 函数
  - 初始化 MsQuic 服务器
  - 监听来自主进程的命令
  - 处理客户端请求

### 2. 通信组件

- **SharedMemoryIPC**：进程间通信
  - 基于共享内存实现主从进程通信
  - 支持消息的异步发送和接收

- **MsQuicServer**：QUIC 服务器
  - 初始化 QUIC 协议栈
  - 管理监听器和连接
  - 处理客户端连接请求

- **MsQuicSession**：会话管理
  - 管理客户端会话
  - 处理数据流和消息
  - 维护会话状态

### 3. 功能模块

- **MsQuicFileTransfer**：文件传输
  - 支持大文件和小文件传输
  - 处理文件头部解析
  - 管理文件接收和存储

- **MsQuicThreadTaskPool**：线程池
  - 管理工作线程
  - 处理异步任务
  - 优化资源利用

- **MsQuicHandlerSystem**：系统命令处理
  - 处理系统级操作命令
  - 提供系统服务接口

## 数据流

### 1. 进程创建流程

1. 主进程启动并加载配置
2. 主进程为每个子进程分配端口
3. 主进程创建共享内存和子进程
4. 子进程初始化并启动 MsQuic 服务器
5. 子进程通过共享内存通知主进程启动状态

### 2. 客户端请求处理流程

1. 客户端连接到子进程的 MsQuic 服务器
2. MsQuicServer 创建 MsQuicSession 处理会话
3. MsQuicSession 处理数据流和消息
4. 根据消息类型分发到不同的处理器（如文件传输）
5. 处理完成后返回结果给客户端

### 3. 进程管理流程

1. 用户通过命令行与主进程交互
2. 主进程解析命令并执行相应操作
3. 对于需要子进程执行的命令，通过共享内存发送
4. 子进程执行命令并返回结果
5. 主进程更新状态并向用户反馈

## 关键特性

1. **多进程架构**：提高系统稳定性和容错能力
2. **端口管理**：动态分配和管理端口资源
3. **进程间通信**：高效的共享内存通信机制
4. **文件传输**：支持大小文件的高效传输
5. **命令行界面**：灵活的系统管理接口
6. **资源清理**：完善的资源释放和清理机制

## 技术栈

- **编程语言**：C++
- **网络协议**：QUIC (MsQuic 实现)
- **进程通信**：共享内存 (Windows API)
- **并发处理**：线程池、异步任务
- **文件处理**：流式文件传输
- **操作系统**：Windows

## 扩展性设计

该系统设计具有良好的扩展性，可以通过以下方式进行扩展：

1. 添加新的命令处理器
2. 实现新的消息类型和处理逻辑
3. 扩展文件传输功能
4. 增加更多的系统服务
5. 优化负载均衡策略
